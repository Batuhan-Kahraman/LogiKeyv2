@model List<OgrenciTahsilatViewModel>

@{
    ViewData["Title"] = "Öğrenci Tahsilat";
}
<div class="col-lg-10 col-xxl-11">
    <h2 class="mb-3 lh-sm">Öğrenci Tahsilat Ekle</h2>
    @if (TempData["Msg"] != null)
    {
        <div class="d-flex">
            <div class="toast show align-items-center text-white dark__text-gray-1100 border-0 m-3" role="alert" data-bs-autohide="false" aria-live="assertive" aria-atomic="true" style="background:@TempData["Bgcolor"]">
                <div class="d-flex">
                    <div>
                        @TempData["Msg"]
                    </div>

                </div>
            </div>
        </div>

    }
        <div class="card shadow-none border my-4" data-component-card="data-component-card">
            <div class="card-header p-4 border-bottom bg-body">
                <div class="row g-3 justify-content-between align-items-center">
                   
                    <form id="form" class="col-md-6 col-xs-3 row" action="@Url.Action("Index","OgrenciTahsilat")" method="get">

                        <div class="col-md-7 col-xs-3">
                            <input class="form-control" id="Icerik" type="text" name="ogrenciDeger" placeholder="Öğrenci Tc No veya Ad Soyad Giriniz" />

                        </div>
                        <div class="col-md-4 col-xs-3">
                            <button type="submit" class="btn btn-primary">Ara</button>
                        </div>
                    </form>


                    

                    <div class="col-md-3">
                    </div>
                </div>
            </div>

        </div>
    <div class="p-4 code-to-copy">
        <div id="tableExample3" data-list='{"valueNames":["tcNo","adi","soyadi","anlasmaTutar","okulAdi","vadeBaslangicTarihi"],"page":10,"pagination":true}'>
            <div>
                <a asp-controller="OgrenciTahsilat" asp-action="OgrenciTahsilatEkle">Tahsilat Ekle</a>
            </div>
            <div class="search-box mb-3 mx-auto">
                <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
                    <input class="form-control search-input search form-control-sm" type="search" placeholder="Ara" aria-label="Ara" />
                    <span class="fas fa-search search-box-icon"></span>
                </form>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-sm fs-9 mb-0" id="myTable">
                    <thead>
                        <tr>
                            <th class="sort border-top border-translucent ps-3" data-sort="tcNo">Öğrenci Tc No</th>
                            <th class="sort border-top border-translucent ps-3" data-sort="adi">Öğrenci Adı</th>
                            <th class="sort border-top border-translucent ps-3" data-sort="soyadi">Öğrenci Soyadı</th>
                            <th class="sort border-top border-translucent ps-3" data-sort="anlasmaTutar">Anlaşma Tutar</th>
                            <th class="sort border-top border-translucent ps-3" data-sort="okulAdi">Okul Adı</th>
                            <th class="sort border-top border-translucent ps-3" data-sort="vadeBaslangicTarihi">Vade Başlangıç Tarihi</th>
                            <th class="sort border-top">
                                İşlemler
                            </th>

                        </tr>
                    </thead>
                    <tbody class="list">
                        @if(Model == null)
                        {
                            <tr>
                                <td>Öğrenci taksiterini görmek için öğrenci aratınız.</td>
                            </tr>
                        }else if(Model.Count == 0)
                        {
                            <tr>
                                <td>Öğrenci bulunamadı.</td>
                            </tr>
                        }
                        else{
                            foreach (var item in Model)
                            {
                                <tr>
                                    <td class="sort border-top border-translucent ps-3 tcNo">@item.ogrenci.Cari_TCNO_VergiNo</td>
                                    <td class="sort border-top border-translucent ps-3 adi">@item.ogrenci.Cari_YetkiliAdi</td>
                                    <td class="sort border-top border-translucent ps-3 soyadi">@item.ogrenci.Cari_YetkiliSoyadi</td>
                                    <td class="sort border-top border-translucent ps-3 anlasmaTutar">@item.ogrenciTahsilat.AnlasilanTutar</td>
                                    <td class="sort border-top border-translucent ps-3 anlasmaTarihi">@item.okul.Cari_Unvan</td>
                                    <td class="sort border-top border-translucent ps-3 vadeBaslangicTarihi">@item.ogrenciTahsilat.VadeBaslangicTarihi</td>
                                    <td>
                                        <a href="#" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="OgrenciTahsilatDetay(@item.ogrenci.Cari_ID)"  >
                                            <span class="text-body fs-5" data-feather="edit"></span>
                                        </a>
                                        @*<a href="#" data-bs-toggle="modal" data-bs-target="#sil" onclick="document.getElementById('silID').value='';"><span class="text-body fs-5" data-feather="trash-2"></span></a>*@

                                    </td>
                                </tr>
                            }
                        }
                        
                    </tbody>
                </table>
                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Öğreci Ödeme Bilgileri</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form>
                                   <div class="row">
                                      <div class="col">

                                        <label class="form-label">Tc No</label>
                                        <input type="text" class="form-control" id="tcNo" aria-label="Tc No" readonly>
                                      </div>
                                      <div class="col">
                                            <label class="form-label">Ad Soyad</label>
                                            <input type="text" class="form-control" id="adSoyad" aria-label="Ad Soyad" readonly>
                                      </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <label class="form-label">Anlaşma Tutar</label>
                                            <input type="text" class="form-control" id="anlasmaTutar" aria-label="Anlaşma Tutar" readonly>
                                        </div>
                                        <div class="col">
                                            <label class="form-label">Kalan Borç</label>
                                            <input type="text" class="form-control" id="kalanBorc" aria-label="Kalan Borç" readonly>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <label class="form-label">Anlaşma Tarihi</label>
                                            <input type="text" class="form-control" id="anlasmaTarihi" aria-label="Anlaşma Tarihi" readonly>
                                        </div>
                                        <div class="col">
                                            <label class="form-label">Vade Başlangıç Tarihi</label>
                                            <input type="text" class="form-control" id="vadeBaslangicTarihi" aria-label="Vade Başlangıç Tarihi" readonly>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col">
                                            <label class="form-label">Taksit Sayısı</label>
                                            <input type="text" class="form-control" id="taksitSayisi" aria-label="Taksit Sayısı" readonly>
                                        </div>
                                        
                                     
                                    </div>
                                    <div class="table-responsive mt-5">
                                        <div class="row mb-5 ">
                                           
                                            <div class="col-6" id="odemeSekliBox">
                                                <input type="text" class="form-control" id="odemeInput" hidden>
                                                <input type="datetime" class="form-control" id="taksitTarih" readonly>

                                                <label class="form-label ">Ödeme Şekli Seçin</label>
                                                <select class="form-control" id="odemeSekli">
                                                    <option value="3" selected>Seçiniz</option>
                                                    <option value="0">Nakit</option>
                                                    <option value="1">Pos</option>
                                                    <option value="2">
                                                        Havale/EFT
                                                    </option>


                                                </select>
                                            </div>

                                        </div>
                                        <table class="table table-striped table-sm fs-9 mb-0 " id="myTable">
                                            <thead>
                                                <tr>
                                                    <th class="sort border-top border-translucent ps-3" >Ödeme Tarihi</th>
                                                    <th class="sort border-top border-translucent ps-3" >Tutar</th>
                                                    <th class="sort border-top border-translucent ps-3" >Ödeme Durumu</th>
                                                    <th class="sort border-top border-translucent ps-3" >Ödeme Şekli</th>
                                                    <th class="sort border-top">
                                                        İşlemler
                                                    </th>

                                                </tr>
                                            </thead>
                                            <tbody class="modal-list">
                                                
                                                

                                            </tbody>
                                        </table>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <input type="hidden" id="tahsilatId" name="tahsilatId" >
                                <a type="submit" id="silBtn" class="btn btn-danger"  >Tahsilatı Sil</a>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                                <button type="button" class="btn btn-primary" onclick="OdemeKaydet()">Kaydet</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal fade" id="sil" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Emin Misiniz?</h5><button class="btn p-1" type="button" data-bs-dismiss="modal" aria-label="Close"><span class="fas fa-times fs-9"></span></button>
                            </div>
                            <form action="OgrenciTahsilat/OgrenciTahsilatSil" method="post">
                                <div class="modal-body">

                                    <p class="text-body-tertiary lh-lg mb-0">
                                        <input type="hidden" name="tcNo" id="silID" value="" />
                                        Bu öğeyi silmek istediğinizden emin misiniz?
                                    </p>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-danger" type="submit">Sil</button>
                                    <button class="btn btn-outline-primary" type="button" data-bs-dismiss="modal">Vazgeç</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>


            </div>
            <div class="d-flex justify-content-between mt-3">
                <span class="d-none d-sm-inline-block" data-list-info="data-list-info"></span>
                <div class="d-flex">
                    <button class="page-link" data-list-pagination="prev"><span class="fas fa-chevron-left"></span></button>
                    <ul class="mb-0 pagination"></ul><button class="page-link pe-0" data-list-pagination="next"><span class="fas fa-chevron-right"></span></button>
                </div>
            </div>
        </div>
    </div>

</div>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

    <script>
        $(document).ready(function(){
            $("#odemeSekliBox").hide();
        })
        $("#silBtn").click(function () {
            var id = $("#tahsilatId").val();
            console.log("Tahsilat ID: " + id);

            $.ajax({
                url: '/OgrenciTahsilat/OgrenciTahsilatSil', // Controller'ın endpoint'i
                method: 'POST',
                data: { id: id }, // Gönderilecek veri
                success: function (response) {
                    // Başarılı işlem durumunda yapılacaklar
                    console.log(response);
                    window.location.reload();
                    // Örneğin başka bir işlem yapabilirsiniz veya bir mesaj gösterebilirsiniz
                },
                error: function (error) {
                    // Hata durumunda yapılacaklar
                    console.log('Hata oluştu:', error);
                }
            });
        });
        function OdemeSec(id){
            $("#odemeSekliBox").show();
            $("#odemeInput").val(id);
            console.log(odemeInput)
            $.ajax({
                url: '../Ajax/OgrenciTaksitBilgileri', // Verileri sağlayan API'nin endpoint'i
                method: 'GET',
                data: { id: id},
                dataType: 'json',
                success: function (data) {
                    console.log(data)
                    if(data.odemeSekli == null){
                        $("#odemeSekli").val(3);

                    }else{
                        $("#odemeSekli").val(data.odemeSekli);

                    }
                    var tarih = data.odemeTarihi.substring(0, 10);
                    $("#taksitTarih").val(tarih)



                },
                error: function (error) {
                    console.log('Hata oluştu:', error);
                }
            });
            
        }
        function OdemeKaydet(){
            var odemeValue = $("#odemeSekli").val();
            var odemeInput = $("#odemeInput").val();
            console.log(odemeInput);
            console.log(odemeValue);
            $.ajax({
                url: '../Ajax/OdemeIslemi', // Verileri sağlayan API'nin endpoint'i
                method: 'POST',
                data: { id: odemeInput, odemeValue: odemeValue },
                dataType: 'json',
                success: function (data) {
                    if (data.odemeTahsilat.odemeDurumu == true) {
                    $("#odemeDurumu"+odemeInput).text("Ödendi");
                        $("#kalanBorc").val(data.odeme.kalanBorcTutar);
                    }else{
                        $("#odemeDurumu" + odemeInput).text("Ödenmedi");
                        $("#kalanBorc").val(data.odeme.kalanBorcTutar);


                    }
                    if (data.odemeTahsilat.odemeSekli == "0") {
                        $("#odemeSekli"+odemeInput).text("Nakit");


                    } else if (data.odemeTahsilat.odemeSekli == "1") {
                        $("#odemeSekli"+odemeInput).text("POS");


                    } else if (data.odemeTahsilat.odemeSekli == "2") {
                        $("#odemeSekli"+odemeInput).text("Havale/EFT");


                    }else{
                        $("#odemeSekli" + odemeInput).text("-");


                    }


                },
                error: function (error) {
                    console.log('Hata oluştu:', error);
                }
            });
        }
        function OgrenciTahsilatDetay(id) {
            $("#odemeSekliBox").hide();
            $("#odemeInput").val();


            $.ajax({
                url: '../Ajax/OgrenciTahsilatDetay', // Verileri sağlayan API'nin endpoint'i
                method: 'GET',
                data: { id: id },
                dataType: 'json',
                success: function (data) {
                    $(".modal-list").empty()
                    console.log(data);
                    $("#tcNo").val(data.ogrenciBilgi.ogrenci.cari_TCNO_VergiNo)
                    $("#adSoyad").val(data.ogrenciBilgi.ogrenci.cari_Unvan)
                    $("#anlasmaTutar").val(data.ogrenciBilgi.ogrenci.cari_TCNO_VergiNo)
                    $("#kalanBorc").val(data.ogrenciBilgi.ogrenciTahsilat.kalanBorcTutar)
                    $("#anlasmaTarihi").val(data.ogrenciBilgi.ogrenciTahsilat.anlasmaTarihi)
                    $("#vadeBaslangicTarihi").val(data.ogrenciBilgi.ogrenciTahsilat.vadeBaslangicTarihi)
                    $("#taksitSayisi").val(data.ogrenciBilgi.ogrenciTahsilat.taksitSayisi)
                    $("#tahsilatId").val(data.ogrenciBilgi.ogrenciTahsilat.id)
                    if(data.ogrenciBilgi.ogrenciTahsilat.odemeSekli == "0"){
                        $("#odemeSekli").val("Nakit")

                    } else if (data.ogrenciBilgi.ogrenciTahsilat.odemeSekli == "1") {
                        $("#odemeSekli").val("POS")

                    }else{
                        $("#odemeSekli").val("Havale/EFT")

                     }

                     data.resultList.forEach(function(item){

                        var newRow = $("<tr>");
                        var cell1 = $("<td class='sort border-top border-translucent ps-3' > ").text(item.ogrenciTahsilatBilgileri.odemeTarihi);
                        var cell2 = $("<td class='sort border-top border-translucent ps-3' > ").text(item.ogrenciTahsilatBilgileri.tutar);
                        if (item.ogrenciTahsilatBilgileri.odemeDurumu == true){
                            var cell3 = $("<td class='sort border-top border-translucent ps-3 '  > ").attr("id", "odemeDurumu" + item.ogrenciTahsilatBilgileri.id).text("Ödendi");

                        }else{
                            var cell3 = $("<td class='sort border-top border-translucent ps-3' >  ").attr("id", "odemeDurumu" + item.ogrenciTahsilatBilgileri.id).text("Ödenmedi");

                        }
                        if (item.ogrenciTahsilatBilgileri.odemeSekli == null){
                            var cell4 = $("<td class='sort border-top border-translucent ps-3' > ").attr("id", "odemeSekli" + item.ogrenciTahsilatBilgileri.id).text("-");

                        } else if (item.ogrenciTahsilatBilgileri.odemeSekli == "0"){
                            var cell4 = $("<td class='sort border-top border-translucent ps-3' > ").attr("id", "odemeSekli"+ item.ogrenciTahsilatBilgileri.id).text("Nakit");

                        } else if (item.ogrenciTahsilatBilgileri.odemeSekli == "1") {
                            var cell4 = $("<td class='sort border-top border-translucent ps-3' > ").attr("id", "odemeSekli"+ item.ogrenciTahsilatBilgileri.id).text("POS");

                        } else {
                            var cell4 = $("<td class='sort border-top border-translucent ps-3' > ").attr("id", "odemeSekli" + item.ogrenciTahsilatBilgileri.id).text("Havale/EFT");

                        }
                        var cell5 = $("<td>").addClass("sort border-top border-translucent ps-3").append(
                            $("<a>").attr("onclick", "OdemeSec(" + item.ogrenciTahsilatBilgileri.id + ")").append(
                                $("<i>").addClass("text-body fas fa-wallet")
                            )
                        );
                        newRow.append(cell1);
                        newRow.append(cell2);
                        newRow.append(cell3);
                        newRow.append(cell4);
                        newRow.append(cell5);
                        $(".modal-list").append(newRow)


                    })


                },
                error: function (error) {
                    console.log('Hata oluştu:', error);
                }
            });
        }
    </script>

}

