@model EntityLayer.Concrate.Kullanicilar

@{
    ViewData["Title"] = "Kullanıcı Düzenle";
}
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>
    var evrakDizisi = [];

    function EvraklarListe(sira, selected = "") {

        //EhliyetSinifi listele
        $.ajax({
            url: '../Ajax/EvraklarListe', // Verileri sağlayan API'nin endpoint'i
            method: 'GET',
            dataType: 'json',
            success: function (data) {
                $('#Evraklar' + sira + 'ID').empty();
                $('#Evraklar' + sira + 'ID').append($('<option>', {
                    value: "", // Verinin değer özelliği
                    text: "Seçiniz", // Verinin görünen metni
                    disabled: true, // Option elementini devre dışı bırak
                    selected: true  // Option elementini seçili yap
                }));
                // Verileri selectbox'a ekle
                $.each(data, function (index, item) {
                    console.log(item);
                    if (selected == item.id) {
                        $('#Evraklar' + sira + 'ID').append($('<option>', {
                            value: item.id, // Verinin değer özelliği
                            text: item.adi, // Verinin görünen metni
                            selected: true
                        }));
                    }
                    else {

                        $('#Evraklar' + sira + 'ID').append($('<option>', {
                            value: item.id, // Verinin değer özelliği
                            text: item.adi // Verinin görünen metni
                        }));
                    }
                });
            },
            error: function (error) {
                console.log('Hata oluştu:', error);
            }
        });
    }


</script>

<div class="col-lg-30 col-xxl-12">

    @if (Model.KullaniciGrup_ID == 2)
    {
        <h2 class="mb-3 lh-sm">Sürücü Düzenle</h2>
    }
    else
    {
        <h2 class="mb-3 lh-sm">Kullanıcı Düzenle</h2>
    }
    @if (TempData["Msg"] != null)
    {
        <div class="d-flex">
            <div class="toast show align-items-center text-white dark__text-gray-1100 border-0 m-3" role="alert" data-bs-autohide="false" aria-live="assertive" aria-atomic="true" style="background:@TempData["Bgcolor"]">
                <div class="d-flex">
                    <div>
                        @TempData["Msg"]
                    </div>

                </div>
            </div>
        </div>

    }

    <div class="border table-responsive scrollbar p-2">

        <form method="post" onsubmit="return validateCheckboxes()">
            <input type="hidden" asp-for="Kullanici_ID" />
            <table class="table table-borderless">
                <!-- Sahiplik -->
                <tr>
                    <td>T.C. Numarası</td>
                    <td><input type="text" class="form-control" asp-for="TC" /></td>
                    <td>
                        <span style="color:red;">*</span>İsim
                    </td>
                    <td>
                        <input type="text" class="form-control" asp-for="Kullanici_Isim" required />

                    </td>
                    <td>Soyisim</td>
                    <td>
                        <input type="text" class="form-control" asp-for="Kullanici_Soyisim" required />
                    </td>
                </tr>
                <tr>
                    @if (Model.KullaniciGrup_ID != 2)
                    {
                        <td>
                            <span style="color:red;">*</span>Kullanıcı Grubu
                        </td>
                        <td class="d-flex">
                            <a asp-controller="KullaniciGrup" asp-action="Index" target="_blank" class="me-2">
                                <span class="text-body fs-5" data-feather="plus"></span>
                            </a>
                            <a onclick="KullaniciGrupListe()" class="me-2" style="cursor:pointer;">
                                <span class="text-body fs-5" data-feather="refresh-ccw"></span>
                            </a>
                            <select class="form-control" asp-for="KullaniciGrup_ID" id="KullaniciGrup_ID" onchange="toggleFields()" required>
                                <option value="" disabled selected>Seçiniz</option>

                            </select>
                        </td>
                    }
                    else
                    {
                       <input asp-for="KullaniciGrup_ID" type="hidden" value="2" />
                    }

                   
                    <td>Brüt Maaş</td>
                    <td>
                        <input type="text" class="form-control" asp-for="Maas" />
                    </td>


                    <td>
                        <span style="color:red;">*</span>Modul
                    </td>
                    <td>
                        @foreach (var item in ViewBag.TumModuller)
                        {

                            if (ViewBag.Moduller != null && ViewBag.Moduller.ToString().Contains(item.Modul_ID.ToString()))
                            {
                                if (ViewBag.Moduller != null && Model.KullaniciModul_ID != null && Model.KullaniciModul_ID.ToString().Contains(item.Modul_ID.ToString()))
                                {

                                    <input type="checkbox" name="FirmaModul_ID[]" value="@item.Modul_ID" checked />
                                    <label>@item.Modul_Adi</label>
                                }
                                else
                                {


                                    <input type="checkbox" name="FirmaModul_ID[]" value="@item.Modul_ID" />
                                    <label>@item.Modul_Adi</label>
                                }

                            }

                            <br />
                        }

                    </td>
                </tr>
                <tr>
                    <td>Doğum Tarihi</td>
                    <td>
                        <input type="date" class="form-control" asp-for="DogumTarihi" />
                    </td>
                    <td>Kan Grubu</td>
                    <td>
                        <input type="text" class="form-control" asp-for="KanGrubu" />
                    </td>
                    <td>Cep Telefonu</td>
                    <td><input type="text" class="form-control" asp-for="CepTelefonu" /></td>
                </tr>
                <tr>
                    <td>
                        <span style="color:red;">*</span>E-Posta Adresi
                    </td>
                    <td><input type="text" class="form-control" asp-for="Kullanici_Eposta" required /></td>
                    <td>Pozisyon</td>
                    <td class="d-flex">
                        <a asp-controller="SurucuPozisyon" asp-action="Index" target="_blank" class="me-2">
                            <span class="text-body fs-5" data-feather="plus"></span>
                        </a>
                        <a onclick="SurucuPozisyonListe()" class="me-2" style="cursor:pointer;">
                            <span class="text-body fs-5" data-feather="refresh-ccw"></span>
                        </a>
                        <select class="form-control" asp-for="SurucuPozisyonID" id="SurucuPozisyonID">
                            <option value="" disabled selected>Seçiniz</option>
                        </select>
                    </td>
                    <td>Şifre</td>
                    <td><input type="text" class="form-control" name="Kullanici_Sifre" /></td>

                </tr>
                <tr>
                    <td>İşe Giriş Tarihi</td>
                    <td><input type="date" class="form-control" asp-for="GirisTarihi" /></td>
                    <td>İşten Çıkış Tarihi</td>
                    <td><input type="date" class="form-control" asp-for="CikisTarihi" /></td>
                    <td>Çıkış Nedeni</td>
                    <td><input type="text" class="form-control" asp-for="CikisNedeni" /></td>
                </tr>
                <tr>
                    <td>Adres</td>
                    <td>
                        <textarea asp-for="Adres" class="form-control"></textarea>

                    </td>
                    <td>İl</td>
                    <td>
                        <select class="form-control" asp-for="IlID" id="IlID" onchange="IlDegistir(this.value)">
                            <option value="" disabled selected>Seçiniz</option>
                            @foreach (var item in ViewBag.Iller)
                            {

                                if (Model.IlID != null && Model.IlID.ToString() == item.IL_KODU)
                                {
                                    <option value="@item.IL_KODU" selected>@item.Il</option>
                                }
                                else
                                {
                                    <option value="@item.IL_KODU">@item.Il</option>
                                }
                            }
                        </select>
                    </td>
                    <td>İlçe</td>
                    <td>
                        <select class="form-control" asp-for="IlceID" id="IlceID">
                            <option value="" disabled selected>Seçiniz</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td>Not</td>
                    <td colspan="5">
                        <textarea rows="2" asp-for="Notlar" class="form-control"></textarea>

                    </td>
                </tr>
                <tr id="hiddenFields">
                    <td>Ehliyet Sınıfı</td>
                    <td class="d-flex">
                        <a asp-controller="EhliyetSinifi" asp-action="Index" target="_blank" class="me-2">
                            <span class="text-body fs-5" data-feather="plus"></span>
                        </a>
                        <a onclick="EhliyetSinifiListe()" class="me-2" style="cursor:pointer;">
                            <span class="text-body fs-5" data-feather="refresh-ccw"></span>
                        </a>
                        <select class="form-control" asp-for="EhliyetSinifiID" id="EhliyetSinifiID">
                            <option value="" disabled selected>Seçiniz</option>

                        </select>

                    </td>

                    <td>Ehliyet Numarası</td>
                    <td>
                        <input type="text" class="form-control" asp-for="EhliyetNumarasi" />
                    </td>
                    <td>Ehliyet Seri Numarası</td>
                    <td>
                        <input type="text" class="form-control" asp-for="EhliyetSeriNumarasi" />
                    </td>
                </tr>

                <tr id="hiddenFields2">
                    <td> Ehliyet Veriliş Tarihi</td>
                    <td>
                        <input type="date" class="form-control" asp-for="EhliyetVerilisTarihi" />
                    </td>
                    <td>Ehliyet Geçerlilik Tarihi</td>
                    <td>
                        <input type="date" class="form-control" asp-for="EhliyetGecerlilikTarihi" />
                    </td>
                </tr>


            </table>
            <table class="table table-borderless" id="hiddenFields4" style="width:100%;">
                <tr>

                    <td colspan="6">
                        <a onclick="EvrakSatiriEkle()"> Evrak Ekle</a>
                    </td>
                </tr>
                @{
                    int sira = 1;
                    foreach (var item in ViewBag.KullaniciEvraklar)
                    {
                        string id = "Evraklar" + sira + "ID";
                        string trid = "TREvraklar" + sira + "ID";

                        <tr id="@trid">
                                                <td>
                                <a onclick="EvrakSatirSil('@trid')">
                                                        <span class="text-body fs-5" data-feather="x" style="color:red;"></span>
                                                    </a>
                                                </td>
                                                <td>Evrak</td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <a asp-controller="Evraklar" asp-action="Index" target="_blank" class="me-2">
                                                            <span class="text-body fs-5" data-feather="plus"></span>
                                                        </a>
                                                        <a onclick="EvraklarListe(@sira)" class="me-2" style="cursor:pointer;">
                                                            <span class="text-body fs-5" data-feather="refresh-ccw"></span>
                                                        </a>
                                    <select class="form-control" name="Evraklar[]" id="@id" style="width:100%">
                                                            <option value="" disabled selected>Seçiniz</option>

                                                        </select>
                                                    </div>
                                                </td>
                                                <td>Veriliş Tarihi</td>
                                                <td>
                                                    <input type="date" class="form-control" name="EvraklarVerilisTarihi[]" value="@item.EvraklarVerilisTarihi.ToString("yyyy-MM-dd")" />

                                                </td>
                                                <td>Geçerlilik Tarihi</td>
                                                <td>
                                                    <input type="date" class="form-control" name="EvraklarGecerlilikTarihi[]" value="@item.EvraklarGecerlilikTarihi.ToString("yyyy-MM-dd")" />
                                                </td>
                                            </tr>

                                            <script>

                                             evrakDizisi.push({ sira: @sira, deger: @item.EvrakID });
                                                console.log(evrakDizisi);
                                            </script>

                        sira++;
                    }
                }

                
            </table>
            <input type="submit" class="btn btn-success w-100" value="Kullanıcıyı Düzenle" />
        </form>



    </div>

</div>
@section Scripts {

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>

        $(document).ready(function () {
            $('select').select2();

            for (var sayac = 0; sayac < evrakDizisi.length; sayac++) {
                debugger;
                EvraklarListe(evrakDizisi[sayac].sira, evrakDizisi[sayac].deger);
            }

        });
        function formatTarih(tarih) {
            var parcalar = tarih.split('.'); // Tarihi parçalara ayır
            var yil = parcalar[2];
            var ay = parcalar[1];
            var gun = parcalar[0];

            // YYYY-MM-DD biçimindeki ISO 8601 tarih formatına dönüştür
            return yil + '-' + ay + '-' + gun;
        }
        function KullaniciGrupListe(id = "") {
            //araç tür listele
            $.ajax({
                url: '../Ajax/KullaniciGrupListe', // Verileri sağlayan API'nin endpoint'i
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    $('#KullaniciGrup_ID').empty();
                    $('#KullaniciGrup_ID').append($('<option>', {
                        value: "", // Verinin değer özelliği
                        text: "Seçiniz", // Verinin görünen metni
                        disabled: true, // Option elementini devre dışı bırak
                        selected: true  // Option elementini seçili yap
                    }));
                    // Verileri selectbox'a ekle
                    $.each(data, function (index, item) {
                        console.log(item);
                        if (item.kullaniciGrup_ID == id) {
                            $('#KullaniciGrup_ID').append($('<option>', {
                                value: item.kullaniciGrup_ID, // Verinin değer özelliği
                                text: item.kullaniciGrup_Adi, // Verinin görünen metni
                                selected: true
                            }));

                            toggleFields();

                        }
                        else {

                            $('#KullaniciGrup_ID').append($('<option>', {
                                value: item.kullaniciGrup_ID, // Verinin değer özelliği
                                text: item.kullaniciGrup_Adi // Verinin görünen metni
                            }));
                        }
                    });
                },
                error: function (error) {
                    console.log('Hata oluştu:', error);
                }
            });

        }
        KullaniciGrupListe(@Model.KullaniciGrup_ID);

        function SurucuPozisyonListe() {
            //SurucuPozisyon listele
            $.ajax({
                url: '../Ajax/SurucuPozisyonListe', // Verileri sağlayan API'nin endpoint'i
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    $('#SurucuPozisyonID').empty();
                    $('#SurucuPozisyonID').append($('<option>', {
                        value: "", // Verinin değer özelliği
                        text: "Seçiniz", // Verinin görünen metni
                        disabled: true, // Option elementini devre dışı bırak
                        selected: true  // Option elementini seçili yap
                    }));
                    // Verileri selectbox'a ekle
                    $.each(data, function (index, item) {
                        console.log(item);
                        $('#SurucuPozisyonID').append($('<option>', {
                            value: item.id, // Verinin değer özelliği
                            text: item.adi // Verinin görünen metni
                        }));
                    });
                    debugger;
                    var SurucuPozisyonID = @Json.Serialize(Model.SurucuPozisyonID);

                    if (SurucuPozisyonID !== null && SurucuPozisyonID != "") {
                        //document.getElementById("SurucuPozisyonID").value = @Model.SurucuPozisyonID;
                        console.log("if");
                    }
                },
                error: function (error) {
                    console.log('Hata oluştu:', error);
                }
            });
        }

        SurucuPozisyonListe();
        function EhliyetSinifiListe() {
            //EhliyetSinifi listele
            $.ajax({
                url: '../Ajax/EhliyetSinifiListe', // Verileri sağlayan API'nin endpoint'i
                method: 'GET',
                dataType: 'json',
                success: function (data) {
                    $('#EhliyetSinifiID').empty();
                    $('#EhliyetSinifiID').append($('<option>', {
                        value: "", // Verinin değer özelliği
                        text: "Seçiniz", // Verinin görünen metni
                        disabled: true, // Option elementini devre dışı bırak
                        selected: true  // Option elementini seçili yap
                    }));
                    // Verileri selectbox'a ekle
                    $.each(data, function (index, item) {
                        console.log(item);
                        $('#EhliyetSinifiID').append($('<option>', {
                            value: item.id, // Verinin değer özelliği
                            text: item.adi // Verinin görünen metni
                        }));
                    });

                    var EhliyetSinifiID = @Json.Serialize(Model.EhliyetSinifiID);

                    if (EhliyetSinifiID !== null) {
                        //document.getElementById("EhliyetSinifiID").value = @Model.EhliyetSinifiID;
                        console.log("if");
                    }
                },
                error: function (error) {
                    console.log('Hata oluştu:', error);
                }
            });
        }
        EhliyetSinifiListe();

        //EvraklarListe(1);
    </script>
    <script>
        function toggleFields() {

            debugger;


            var selectedOption = document.getElementById("KullaniciGrup_ID");
            var selectedValue = selectedOption.options[selectedOption.selectedIndex].text;
            var hiddenFields = document.getElementById("hiddenFields");
            var hiddenFields2 = document.getElementById("hiddenFields2");
            console.log(hiddenFields, "hiddenFields");
            console.log(selectedValue, "selectedValue");
            if (selectedValue === "Söför") {

                hiddenFields.style.display = "table-row";
                hiddenFields2.style.display = "table-row";
            } else {
                hiddenFields.style.display = "none";
                hiddenFields2.style.display = "none";
            }
        }

        toggleFields();
        function IlDegistir(IlKodu) {

            $.ajax({
                url: '../Ajax/IlceListe', // Verileri sağlayan API'nin endpoint'i
                method: 'GET',
                data: { IlKodu: IlKodu },
                dataType: 'json',
                success: function (data) {
                    $('#IlceID').empty();
                    $('#IlceID').append($('<option>', {
                        value: "", // Verinin değer özelliği
                        text: "Seçiniz", // Verinin görünen metni
                        disabled: true, // Option elementini devre dışı bırak
                        selected: true  // Option elementini seçili yap
                    }));
                    // Verileri selectbox'a ekle
                    $.each(data, function (index, item) {
                        console.log("---");
                        console.log(item);
                        $('#IlceID').append($('<option>', {
                            value: item.ilcE_KODU, // Verinin değer özelliği
                            text: item.ilce // Verinin görünen metni
                        }));
                    });
                    var IlceID = @Json.Serialize(Model.IlceID);

                    if (IlceID !== null) {
                        //document.getElementById("IlceID").value = @Model.IlceID;
                        console.log("if");
                    }
                },
                error: function (error) {
                    console.log('Hata oluştu:', error);
                }
            });
        }


        var IlID = document.getElementById("IlID").value;
        IlDegistir(IlID);

        function validateCheckboxes() {
            var checkboxes = document.getElementsByName('FirmaModul_ID[]');
            var isChecked = false;
            for (var i = 0; i < checkboxes.length; i++) {
                if (checkboxes[i].checked) {
                    isChecked = true;
                    break;
                }
            }
            if (!isChecked) {
                alert("Lütfen en az bir modül seçiniz.");
                return false;
            }
            return true;
        }



        function EvrakSatiriEkle() {
            // hiddenFields4 satırını klonlayın
            var table = document.getElementById("hiddenFields4");

            // Yeni bir satır ekle
            var newRow = table.insertRow();
            var sira = table.getElementsByTagName('tr').length + 1;
            newRow.id = "TREvraklar" + sira + "ID";
            // Yeni satıra hücreler ekle ve içeriği kopyala


            var cell0 = newRow.insertCell(0);
            var cell1 = newRow.insertCell(1);
            var cell2 = newRow.insertCell(2);
            var cell3 = newRow.insertCell(3);
            var cell4 = newRow.insertCell(4);
            var cell5 = newRow.insertCell(5);
            var cell6 = newRow.insertCell(6);


            // İçeriği doldur
            cell0.innerHTML = `<a onclick='EvrakSatirSil("TREvraklar` + sira + `ID") '>
                        <span class="text-body fs-5" data-feather="x" style = "color:red;" width="16px" height="16px" > </span>
                    </a>`;
            cell1.innerHTML = 'Evrak';
            cell2.innerHTML = `<div class="d-flex align-items-center">
                                                 <a href="/Evraklar/Index" target="_blank" class="me-2">
                                                                    <span class="text-body fs-5" data-feather="plus" width="16px" height="16px"></span>
                                                        </a>
                                                                <a onclick="EvraklarListe(`+ sira + `)" class="me-2" style="cursor:pointer;">
                                                                    <span class="text-body fs-5" data-feather="refresh-ccw" width="16px" height="16px"></span>
                                                        </a>
                                                                                        <select class="form-control" name="Evraklar[]" id="Evraklar`+ sira + `ID" style="width:100%">
                                            <option value="" disabled selected>Seçiniz</option>
                                        </select></div>
                                    `;
            cell3.innerHTML = 'Veriliş Tarihi';
            cell4.innerHTML = '<input type="date" class="form-control" name="EvraklarVerilisTarihi[]" />';
            cell5.innerHTML = 'Geçerlilik Tarihi';
            cell6.innerHTML = '<input type="date" class="form-control" name="EvraklarGecerlilikTarihi[]" />';
            EvraklarListe(sira);

            feather.replace();

            $('#Evraklar' + sira + 'ID').select2();
        }

        function EvrakSatirSil(satirID) {
            var satir = document.getElementById(satirID);

            // Satırı sil
            if (satir) {
                satir.parentNode.removeChild(satir);
                console.log("Satır başarıyla silindi.");
            } else {
                console.error("Belirtilen satır bulunamadı.");
            }
        }
    </script>

}